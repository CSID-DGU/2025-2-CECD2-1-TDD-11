name: Create Release Tag

on:
  push:
    branches: [ "app/prod" ]

permissions:
  contents: write

jobs:
  apk:
    name: Generate & Release APK + iOS build
    runs-on: macos-latest

    defaults:
      run:
        working-directory: app

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Prepare local.properties
        run: |
          cat <<EOF > local.properties
          BASE_URL=${{ secrets.BASE_URL }}
          AI_URL=${{ secrets.AI_URL }}
          POLICY_URL=${{ secrets.POLICY_URL }}
          EOF

      - name: Decode google-services.json
        env:
          GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}
        run: |
          mkdir -p app/composeApp
          echo "$GOOGLE_SERVICES" | base64 -d > app/composeApp/google-services.json

      # --------- Android: Release APK 빌드 ----------
      - name: Build Android Release APK
        run: ./gradlew :composeApp:assembleRelease --stacktrace

      - name: Upload Android Release APK (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/composeApp/build/outputs/apk/release/*.apk

      # --------- iOS: KMP 타겟 컴파일 ----------
      - name: iOS targets compile (KMP)
        run: |
          ./gradlew \
            :composeApp:compileKotlinIosSimulatorArm64 \
            :composeApp:compileKotlinIosArm64

      # --------- iOS: XCode Release 빌드 (시뮬레이터용) ----------
      - name: iOS Xcode build (iosApp Release for Simulator)
        working-directory: app/iosApp
        run: |
          xcodebuild \
            -project iosApp.xcodeproj \
            -scheme iosApp \
            -configuration Release \
            -sdk iphonesimulator \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build/ios \
            ARCHS=arm64 \
            EXCLUDED_ARCHS="x86_64" \
            build

      # --------- iOS: 빌드된 ios를 아티팩트로 업로드 ----------
      - name: Package iOS .app as zip
        working-directory: app/iosApp
        run: |
          APP_PATH=$(find build/ios/Build/Products -maxdepth 4 -name "*.app" -print | head -n 1)
          echo "Found app: $APP_PATH"
          if [ -z "$APP_PATH" ]; then
            echo "No .app found under build/ios/Build/Products"
            ls -R build/ios || true
            exit 1
          fi
          zip -r iosApp-Release-iphonesimulator.zip "$APP_PATH"

      - name: Upload iOS build (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: iosApp-release-simulator
          path: app/iosApp/iosApp-Release-iphonesimulator.zip

      # --------- 버전 추출 ----------
      - name: Extract version from commit message
        id: extract_version
        shell: bash
        run: |
          MSG="${{ github.event.head_commit.message }}"
          if [[ $MSG =~ ([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            TAG="v${VERSION}"
          else
            VERSION="$(date +'%Y.%m.%d')-${{ github.run_number }}"
            TAG="v${VERSION}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"         >> "$GITHUB_OUTPUT"

     
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.extract_version.outputs.tag }}
          name:     ${{ steps.extract_version.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            app/composeApp/build/outputs/apk/release/*.apk
            app/iosApp/iosApp-Release-iphonesimulator.zip
          body: |
            ## ${{ steps.extract_version.outputs.tag }} 릴리즈
            - Android Release APK가 포함되어 있습니다.
            - iOS 시뮬레이터용 .app 빌드가 포함되어 있습니다.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
